<script>
    Namespace.register('basedata.postmenufuncview');
    $(function () {
        basedata.postmenufuncview.postdg = $('#basedata-postmenufunc-postdg').datagrid({
            columns: [
                [   {% autoescape off %}
                    {{ postid.writeUI|safe|escape }},
                    {{ postname.writeUI|safe|escape }},
                {% endautoescape %}
                ]
            ],
            pagination: false,
            queryFuncName: '岗位查询',
            onDblClickRow: function (rowIndex, rowData) {
                return;
            },
            onClickRow: function (rowIndex, rowData) {
                var id = rowData.id;
                basedata.postmenufuncview.postdg.refreshFunc(id);
            }
        });
        basedata.postmenufuncview.postdg.refreshFunc = function (postid) {
            var param = {
                type: 'query',
                func: '岗位权限查询',
                postid: postid
            }
            $.ajax({
                url: "./dealPAjax/",
                data: {jpargs: JSON.stringify(param)},
                success: function (r, t, a) {
                    //console.info(r);
                    basedata.postmenufuncview.menufunctree.tree('loadData', r);
                    basedata.postmenufuncview.menufunctree.tree('collapseAll');
                    $.ajaxSettings.success(r, t, a);
                }
            });
        }
        basedata.postmenufuncview.menufunctree = $('#basedata-postmenufunc-menufunctree').tree({
            checkbox: true,
            lines: true
        });
        $('#basedata-postmenufunc-savebutton').bind('click', function () {
            var rootNodes = basedata.postmenufuncview.menufunctree.tree('getRoots');
            var postid = basedata.postmenufuncview.postdg.datagrid('getSelected').id;
            var optype = '';
            var menuid,funcid,table;
            var rows = new Array();
            for (var i = 0, ilen = rootNodes.length; i < ilen; i++) {
                if (!basedata.postmenufuncview.menufunctree.tree('isLeaf', rootNodes[i].target)) {
                    var nodes = basedata.postmenufuncview.menufunctree.tree('getChildren', rootNodes[i].target);
                    for (j = 0, jlen = nodes.length; j < jlen; j++) {
                        if ((nodes[j].checked ^ nodes[j].attributes.oldval) == 1 ) {
                            if (nodes[j].checked) {
                                optype = 'insert';
                            } else {
                                optype = 'delete'
                            }
                            if (nodes[j].attributes.type == 'func'){
                                funcid = nodes[j].attributes.id;
                                menuid = basedata.postmenufuncview.menufunctree.tree('getParent',nodes[j].target).attributes.id;
                                table = 'func';
                            }else{
                                funcid = -1;
                                menuid = nodes[j].attributes.id;
                                table = 'menu';
                            }
                            rows.push({
                                op: optype,
                                table: table,
                                menuid: menuid,
                                funcid: funcid,
                                postid: postid
                            });
                        }
                    }
                }
                if ((rootNodes[i].checked ^ rootNodes[i].attributes.oldval) == 1) {
                    if (rootNodes[i].checked) {
                        optype = 'insert';
                    } else {
                        optype = 'delete';
                    }
                    rows.push({
                        op: optype,
                        table: 'menu',
                        menuid: rootNodes[i].attributes.id,
                        funcid: -1,
                        postid: postid
                    });
                }
            }
            //处理indeterminate状态节点
            var fuzzyNodes = basedata.postmenufuncview.menufunctree.tree('getChecked','indeterminate');
            for (f = 0,flen = fuzzyNodes.length;f < flen;f++){
                if (!fuzzyNodes[f].attributes.oldval){
                    rows.push({
                        op: 'insert',
                        table: 'menu',
                        menuid: fuzzyNodes[f].attributes.id,
                        funcid: -1,
                        postid: postid
                    });
                }
            }
            if (rows.length == 0) {
                return;
            }
            rows.sort(sy.createComparsion('op','desc'));
            rows.sort(sy.createComparsion('table','desc'));
            var p = {
                reqtype: 'sysfunc',
                func: 'menufuncpost',
                rows: rows
            }
            $.ajax({
                url: "./dealPAjax/",
                data: {jpargs: JSON.stringify(p)},
                success: function (returnData, returnMsg, ajaxObj) {
                    $.ajaxSettings.success(returnData, returnMsg, ajaxObj);
                    var stateCod = parseInt(returnData.stateCod);
                    if (!isNaN(stateCod)) {
                        if (returnData.stateCod == 202) { //更新成功
                            basedata.postmenufuncview.postdg.refreshFunc(postid);
                        }
                    }
                }
            });
        });
    });
</script>

<div class="easyui-layout" data-options="fit:true,border:false">
    <div region="north" border="false" style="height: 200px" data-options="split:true">
        <table id="basedata-postmenufunc-postdg" border="false">
        </table>
    </div>
    <div region="center" border="false">
        <ul id="basedata-postmenufunc-menufunctree"></ul>
    </div>
    <div region="south" border="false" style="height:25px;">
        <a id="basedata-postmenufunc-savebutton" href="#" class="easyui-linkbutton">保存</a>
    </div>
</div>