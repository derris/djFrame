<script>
    Namespace.register('audit.auditview');
    $(function () {
        audit.auditview.actfeegrid = null;
        audit.auditview.prefeegrid = null;
        $(document).on('afterrender', '#control-audit-actfeegrid-{{ seq }}', function (e, grid) {
            audit.auditview.actfeegrid = $(grid);
            audit.auditview.actfeegrid.datagrid('options').queryFuncName = '实收付未核销查询';
        });
        audit.auditview.refresh = function (param) {
            audit.auditview.actfeegrid.datagrid('options').filterFields = [];
            audit.auditview.prefeegrid.datagrid('options').filterFields = [];
            $('#audit-auditview-auditbutton').linkbutton('enable');
            if (param.client != null && param.client.length > 0) {
                audit.auditview.actfeegrid.datagrid('options').filterFields.push({
                    cod: 'client_id',
                    operatorTyp: '等于',
                    value: param.client
                });
                audit.auditview.prefeegrid.datagrid('options').filterFields.push({
                    cod: 'pre_fee.client_id',
                    operatorTyp: '等于',
                    value: param.client
                });
            }else{
                $('#audit-auditview-auditbutton').linkbutton('disable');
            }
            if (param.feetpy != null && param.feetpy.length > 0) {
                audit.auditview.actfeegrid.datagrid('options').filterFields.push({
                    cod: 'fee_typ',
                    operatorTyp: '等于',
                    value: param.feetpy
                });
                audit.auditview.prefeegrid.datagrid('options').filterFields.push({
                    cod: 'pre_fee.fee_typ',
                    operatorTyp: '等于',
                    value: param.feetpy
                });
            }else{
                $('#audit-auditview-auditbutton').linkbutton('disable');
            }
            audit.auditview.actfeegrid.datagrid('reload');
            audit.auditview.prefeegrid.datagrid('reload');
        }
        $(document).on('refresh', '#control-audit-actfeegrid-{{ seq }}', function (e, parm) {
            audit.auditview.refresh(parm);
        });
        $(document).on('afterrender', '#control-audit-prefeegrid-{{ seq }}', function (e, grid) {
            audit.auditview.prefeegrid = $(grid);
            audit.auditview.prefeegrid.datagrid('options').queryFuncName = '应收付未核销查询';
        });
        $('#audit-auditview-auditbutton').bind('click',function(e){
            var actRows = audit.auditview.actfeegrid.datagrid('getChecked');
            var preRows = audit.auditview.prefeegrid.datagrid('getChecked');
            param = {
                func : "核销",
                ex_parm:{
                actfeeid:[],
                prefeeid:[]
                }
            }
            for (var i = 0,ilen=actRows.length;i < ilen;i++){
                param.ex_parm.actfeeid.push(actRows[i].id);
            }
            for (var i = 0,ilen=preRows.length;i < ilen;i++){
                param.ex_parm.prefeeid.push(preRows[i].id);
            }
            $.ajax({
                url: "./dealPAjax/",
                data: {jpargs: JSON.stringify(param)},
                success: function (r, t, a) {
                    var stateCod = parseInt(r.stateCod);
                    if (r && !isNaN(stateCod)) {
                        if (stateCod == 202) {
                            //保存成功刷新界面
                            $('#control-audit-actfeegrid-toolbar-search-{{ seq }}').triggerHandler('click');
                        }
                    }
                    $.ajaxSettings.success(r, t, a, true);
                }
            });
        });

    });
</script>
<div class="easyui-layout" data-options="fit:true,border:false">
    <div data-options="region:'center',border:'false'">
        {% include 'yard/fee/actfeegrid.html' %}
    </div>
    <div data-options="region:'south', split:'true',height:window.innerHeight * 0.6,border:false">
        {% include 'yard/fee/prefeegrid.html' %}
        <div class="editform-toolbar-gridbottom">
            <a id="audit-auditview-auditbutton" href="#" class="easyui-linkbutton"
               data-options="iconCls:'icon-save',group:'audit-auditview'">核销</a>
        </div>
    </div>
</div>
