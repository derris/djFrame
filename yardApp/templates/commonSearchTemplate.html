<script type="text/javascript">
Namespace.register('common.createsearchform');
$(function () {
    common.createsearchform.filterdatagrid = $('#common-createsearchform-filterdatagrid').datagrid({
        columns: [
            [
                {
                    field: 'text',
                    title: '属性',
                    width: 100,
                    align: 'center'
                },
                {
                    field: 'operatorTyp',
                    title: '条件',
                    width: 100,
                    align: 'center',
                    editor: {
                        type: 'combobox',
                        options: {
                            data: [
                                {
                                    value: '等于'
                                },
                                {
                                    value: '不等于'
                                },
                                {
                                    value: '大于'
                                },
                                {
                                    value: '大于等于'
                                },
                                {
                                    value: '小于'
                                },
                                {
                                    value: '小于等于'
                                },
                                {
                                    value: '包含'
                                },
                                {
                                    value: '不包含'
                                },
                                {
                                    value: '属于'
                                },
                                {
                                    value: '不属于'
                                },
                                {
                                    value: '介于'
                                },
                                {
                                    value: '不介于'
                                }
                            ],
                            valueField: 'value',
                            textField: 'value',
                            editable: true,
                            panelHeight: 250,
                            onChange: function (newData, oldData) {
                                if (newData.length == 0) {
                                    var cur_datagrid_row = common.createsearchform.filterdatagrid.editRow;
                                    common.createsearchform.filterdatagrid.datagrid('getRows')[cur_datagrid_row].value = '';
                                    common.createsearchform.filterdatagrid.datagrid('getRows')[cur_datagrid_row].value_text = '';
                                    common.createsearchform.filterdatagrid.datagrid('getRows')[cur_datagrid_row].display_value = '';
                                }
                            }
                        }
                    }
                },
                {
                    field: 'display_value',
                    title: "值,多值用','分隔",
                    width: 400,
                    align: 'right'
                },
                {
                    field: 'editor',
                    hidden: true
                },
                {
                    field: 'cod',
                    hidden: true
                },
                {
                    field: 'value',
                    hidden: true
                },
                {
                    field: 'value_text',
                    hidden: true
                }
            ]
        ],
        idField: 'cod',
        fit: true,
        border: false,
        pagination:false,
        showHeader: true,
        singleSelect: true,
        striped: true,
        onDblClickRow: function (rowIndex, rowData) {
            if (rowData.editor.type == 'datetimebox' || rowData.editor.type == 'datebox') {
                common.createsearchform.filterdatagrid.datagrid('getRows')[rowIndex].display_value = '';
            }
            common.createsearchform.filterdatagrid.datagrid('removeEditor', ['display_value']);
            common.createsearchform.filterdatagrid.datagrid('addEditor', [
                {
                    field: 'display_value',
                    editor: rowData.editor
                }
            ]);
            common.createsearchform.filterdatagrid.datagrid('dbClick', rowIndex);
        },

        onAfterEdit: function (rowIndex, rowData, changes) {
            if (rowData.editor.type == 'combobox' || rowData.editor.type == 'datetimebox' || rowData.editor.type == 'datebox') {
                common.createsearchform.filterdatagrid.datagrid('getRows')[rowIndex].display_value = rowData.value_text;
                common.createsearchform.filterdatagrid.datagrid('refreshRow', rowIndex);
            }
            else {
                common.createsearchform.filterdatagrid.datagrid('getRows')[rowIndex].value = rowData.display_value;
                common.createsearchform.filterdatagrid.datagrid('getRows')[rowIndex].value_text = rowData.display_value;
            }
        }

    });
    common.createsearchform.sorterdatagrid = $('#common-createsearchform-sorterdatagrid').datagrid({
        columns: [
            [
                {
                    field: 'text',
                    title: '属性',
                    width: 100,
                    align: 'center'
                },
                {
                    field: 'order_typ',
                    title: '排序类型',
                    width: 100,
                    align: 'center',
                    editor: {
                        type: 'combobox',
                        options: {
                            data: [
                                {
                                    value: '升序'
                                },
                                {
                                    value: '降序'
                                }
                            ],
                            valueField: 'value',
                            textField: 'value',
                            editable: true,
                            panelHeight: 40
                        }
                    }
                },
                {
                    field: 'cod',
                    hidden: true
                }
            ]
        ],
        toolbar: [
            {
                text: '上移',
                iconCls: '',
                handler: function () {
                    common.createsearchform.sorterdatagrid.datagrid('manualEndEdit');
                    var newRow = common.createsearchform.sorterdatagrid.datagrid('getSelected');
                    if (newRow) {
                        var index = common.createsearchform.sorterdatagrid.datagrid('getRowIndex', newRow);
                        if (index > 0) {
                            common.createsearchform.sorterdatagrid.datagrid('insertRow', {
                                index: index - 1,
                                row: newRow
                            });
                            common.createsearchform.sorterdatagrid.datagrid('deleteRow', index + 1);
                            common.createsearchform.sorterdatagrid.datagrid('unselectAll');
                            common.createsearchform.sorterdatagrid.datagrid('selectRow', index - 1);
                        }
                    }
                }
            },
            '-',
            {
                text: '下移',
                iconCls: '',
                handler: function () {
                    common.createsearchform.sorterdatagrid.datagrid('manualEndEdit');
                    var newRow = common.createsearchform.sorterdatagrid.datagrid('getSelected');
                    if (newRow) {
                        var index = common.createsearchform.sorterdatagrid.datagrid('getRowIndex', newRow);
                        var rowCount = common.createsearchform.sorterdatagrid.datagrid('getRows').length;
                        if (index < rowCount - 1) {
                            common.createsearchform.sorterdatagrid.datagrid('insertRow', {
                                index: index + 2,
                                row: newRow
                            });
                            common.createsearchform.sorterdatagrid.datagrid('deleteRow', index);
                            common.createsearchform.sorterdatagrid.datagrid('unselectAll');
                            common.createsearchform.sorterdatagrid.datagrid('selectRow', index + 1);
                        }
                    }
                }
            },
            '-'
        ],
        idField: 'cod',
        fit: true,
        border: false,
        singleSelect: true,
        pagination:false
    });
    common.createsearchform.colsdatagrid = $('#common-createsearchform-colsdatagrid').datagrid({
        columns: [
            [
                {field: 'text', title: '列', align: 'center', width: 100},
                {field: 'cod', checkbox: true}
            ]
        ],
        idField: 'cod',
        fit: true,
        border: false,
        pagination:false,
        showHeader: true,
        singleSelect:false,
        striped: true

    });
    for (var i = 0,ilen = sy.searchWindowData.length;i<ilen; i++) {
        if (sy.searchWindowData[i].cod == 'id'){
            continue;
        }
        if (sy.searchWindowData[i].hidden != true) {
            if (sy.searchWindowData[i].editor) {
                var commEditorTypes = "text,validatebox,combobox,checkbox,datebox,datetimebox";
                if (commEditorTypes.indexOf(sy.searchWindowData[i].editor.type) < 0) {
                    sy.searchWindowData[i].editor.type = 'text';
                    sy.searchWindowData[i].editor.options = {};
                }
                if (sy.searchWindowData[i].editor.options && sy.searchWindowData[i].editor.options.required) {
                    sy.searchWindowData[i].editor.options.required = false;
                }
                /*
                 if (sy.searchWindowData[i].editor.type == 'validatebox' && sy.searchWindowData[i].editor.options.required == true) {
                 sy.searchWindowData[i].editor.options.required = false;
                 }*/
                if (sy.searchWindowData[i].editor.type == 'combobox') {
                    //sy.searchWindowData[i].editor.options.valueField = 'value';
                    sy.searchWindowData[i].editor.options.multiple = true;
                    sy.searchWindowData[i].editor.options.onSelect = function (record) {
                        var cur_datagrid_row = common.createsearchform.filterdatagrid.datagrid('options').editRow;
                        common.createsearchform.filterdatagrid.datagrid('getRows')[cur_datagrid_row].value = $(this).combo('getValues');
                        common.createsearchform.filterdatagrid.datagrid('getRows')[cur_datagrid_row].value_text = $(this).combo('getText');

                    }
                }
                if (sy.searchWindowData[i].editor.type == 'checkbox') {
                    sy.searchWindowData[i].editor = {
                        type: 'combobox',
                        options: {
                            data: [
                                { cod: 'true', value: '是' },
                                { cod: 'false', value: '否' }
                            ],
                            valueField: 'cod',
                            textField: 'value',
                            editable: true,
                            panelHeight: 40,
                            multiple: false,
                            onSelect: function (record) {
                                var cur_datagrid_row = common.createsearchform.filterdatagrid.editRow;
                                common.createsearchform.filterdatagrid.datagrid('getRows')[cur_datagrid_row].value = $(this).combo('getValues');
                                common.createsearchform.filterdatagrid.datagrid('getRows')[cur_datagrid_row].value_text = $(this).combo('getText');
                            }
                        }
                    };
                }
                if (sy.searchWindowData[i].editor.type == 'datetimebox') {
                    sy.searchWindowData[i].editor = {
                        type: 'datetimebox',
                        options: {
                            required: false,
                            onChange: function (newDate, oldDate) {
                                var cur_datagrid_row = common.createsearchform.filterdatagrid.editRow;
                                if (newDate != null && common.createsearchform.filterdatagrid.datagrid('getRows')[cur_datagrid_row].value.indexOf(newDate) < 0) {
                                    if (common.createsearchform.filterdatagrid.datagrid('getRows')[cur_datagrid_row].value.length > 0) {
                                        common.createsearchform.filterdatagrid.datagrid('getRows')[cur_datagrid_row].value = common.createsearchform.filterdatagrid.datagrid('getRows')[cur_datagrid_row].value + ',' + newDate;
                                        common.createsearchform.filterdatagrid.datagrid('getRows')[cur_datagrid_row].value_text = common.createsearchform.filterdatagrid.datagrid('getRows')[cur_datagrid_row].value_text + ',' + newDate;
                                    } else {
                                        common.createsearchform.filterdatagrid.datagrid('getRows')[cur_datagrid_row].value = newDate;
                                        common.createsearchform.filterdatagrid.datagrid('getRows')[cur_datagrid_row].value_text = newDate;
                                    }
                                }
                            }
                        }
                    };
                }
                if (sy.searchWindowData[i].editor.type == 'datebox') {
                    sy.searchWindowData[i].editor = {
                        type: 'datebox',
                        options: {
                            required: false,
                            onChange: function (newDate, oldDate) {
                                var cur_datagrid_row = common.createsearchform.filterdatagrid.editRow;
                                if (newDate != null && common.createsearchform.filterdatagrid.datagrid('getRows')[cur_datagrid_row].value.indexOf(newDate) < 0) {
                                    if (common.createsearchform.filterdatagrid.datagrid('getRows')[cur_datagrid_row].value.length > 0) {
                                        common.createsearchform.filterdatagrid.datagrid('getRows')[cur_datagrid_row].value = common.createsearchform.filterdatagrid.datagrid('getRows')[cur_datagrid_row].value + ',' + newDate;
                                        common.createsearchform.filterdatagrid.datagrid('getRows')[cur_datagrid_row].value_text = common.createsearchform.filterdatagrid.datagrid('getRows')[cur_datagrid_row].value_text + ',' + newDate;
                                    } else {
                                        common.createsearchform.filterdatagrid.datagrid('getRows')[cur_datagrid_row].value = newDate;
                                        common.createsearchform.filterdatagrid.datagrid('getRows')[cur_datagrid_row].value_text = newDate;
                                    }
                                }
                            }
                        }
                    };
                }
            } else {
                sy.searchWindowData[i].editor = { type: 'text' };
            }
            common.createsearchform.filterdatagrid.datagrid('appendRow', {
                'cod': sy.searchWindowData[i].cod,
                'text': sy.searchWindowData[i].text,
                'editor': sy.searchWindowData[i].editor,
                'value': '',
                'display_value': '',
                'value_text': '',
                'operatorTyp': ''
            });
            common.createsearchform.sorterdatagrid.datagrid('appendRow', {
                'cod': sy.searchWindowData[i].cod,
                'text': sy.searchWindowData[i].text
            });
        }
        common.createsearchform.colsdatagrid.datagrid('appendRow', {
            'cod': sy.searchWindowData[i].cod,
            'text': sy.searchWindowData[i].text
        });
        common.createsearchform.colsdatagrid.datagrid('checkAll');

    }

    $('#common-createsearchform-ok').bind('click', function () {
        common.createsearchform.filterdatagrid.datagrid('manualEndEdit');
        common.createsearchform.sorterdatagrid.datagrid('manualEndEdit');
        common.createsearchform.colsdatagrid.datagrid('manualEndEdit');
        var rows = common.createsearchform.filterdatagrid.datagrid('getRows');
        for (var i = 0,ilen = rows.length; i < ilen;i++) {
            if (rows[i].operatorTyp && rows[i].value) {
                if (rows[i].operatorTyp == '介于' || rows[i].operatorTyp == '不介于') {
                    if (rows[i].value.indexOf(',') > 0) {
                    } else {
                        //$.messager.alert('提示', '第' + (i + 1) + '行条件数据不完整!');
                        $.messager.alert('提示', "'" + rows[i].text + "'" + '条件,提供数据不完整!');
                        return;
                    }
                }
                sy.searchWindowReturnData.filters.push(
                        {
                            cod: rows[i].cod,
                            operatorTyp: rows[i].operatorTyp,
                            value: rows[i].value.toString()
                        });
            }
        }

        var rows = common.createsearchform.sorterdatagrid.datagrid('getRows');
        for (var i = 0,ilen = rows.length; i < ilen;i++) {
            if (rows[i].order_typ) {
                sy.searchWindowReturnData.sorts.push(
                        {
                            cod: rows[i].cod,
                            order_typ: rows[i].order_typ
                        });
            }
        }
        var rows = common.createsearchform.colsdatagrid.datagrid('getChecked');

        for (var i = 0,ilen = rows.length;i<ilen; i++){
            sy.searchWindowReturnData.cols.push(rows[i].cod);
        }
        //console.info(sy.searchWindowReturnData.filters);
        sy.searchWindowReturnData.refreshFlag = true;
        sy.searchWindow.window('close');
    });
});
</script>

<div class="easyui-layout" data-options="fit:true,border:false">
    <div region="center" border="false" data-options="fit:true">

        <div class="easyui-tabs" data-options="fit:true,border:false">
            <div title="过滤">
                <table id="common-createsearchform-filterdatagrid" data-options="fit:true,border:false">
                </table>
            </div>
            <div title="排序">
                <table id="common-createsearchform-sorterdatagrid" data-options="fit:true,border:false">
                </table>
            </div>
            <div title="内容">
                <table id="common-createsearchform-colsdatagrid" data-options="fit:true,border:false">
                </table>
            </div>
        </div>
    </div>

    <div region="south" border="false" style="height:25px;">
        <a id="common-createsearchform-ok" href="#" class="easyui-linkbutton">确定</a>
    </div>
</div>


